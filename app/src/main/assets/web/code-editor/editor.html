
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Legado Editor Pro</title>
  <style>
    :root {
      --bg: #ffffff;
      --gutter-bg: #f5f5f5;
      --gutter-text: #b0b0b0;
      --text: #24292e;
      --border: #e1e4e8;
      --active-line: #f6f8fa;
      --accent: #0366d6;
      --toolbar-bg: #f8f9fa;
      --selection: #b3d7ff;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #1e1e1e;
        --gutter-bg: #252526;
        --gutter-text: #858585;
        --text: #d4d4d4;
        --border: #3e3e42;
        --active-line: #2d2d30;
        --accent: #40a9ff;
        --toolbar-bg: #252526;
        --selection: #264f78;
      }
    }

    body[data-theme="light"] {
      --bg: #ffffff;
      --gutter-bg: #f5f5f5;
      --gutter-text: #b0b0b0;
      --text: #24292e;
      --border: #e1e4e8;
      --active-line: #f6f8fa;
      --accent: #0366d6;
      --toolbar-bg: #f8f9fa;
      --selection: #b3d7ff;
      color-scheme: light;
    }

    body[data-theme="dark"] {
      --bg: #1e1e1e;
      --gutter-bg: #252526;
      --gutter-text: #858585;
      --text: #d4d4d4;
      --border: #3e3e42;
      --active-line: #2d2d30;
      --accent: #40a9ff;
      --toolbar-bg: #252526;
      --selection: #264f78;
      color-scheme: dark;
    }

    body[data-theme="sepia"] {
      --bg: #f7f2e7;
      --gutter-bg: #efe6d6;
      --gutter-text: #9b8f7a;
      --text: #3d3528;
      --border: #e0d6c5;
      --active-line: #f0e7d6;
      --accent: #9a6b32;
      --toolbar-bg: #efe6d6;
      --selection: #d8c7ad;
      color-scheme: light;
    }

    body[data-theme="nord"] {
      --bg: #2e3440;
      --gutter-bg: #3b4252;
      --gutter-text: #8f9bb3;
      --text: #eceff4;
      --border: #434c5e;
      --active-line: #3b4252;
      --accent: #88c0d0;
      --toolbar-bg: #3b4252;
      --selection: #4c566a;
      color-scheme: dark;
    }

    * { box-sizing: border-box; }
    html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; }
    body {
      font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
      background: var(--bg);
      color: var(--text);
      display: flex;
      flex-direction: column;
      overscroll-behavior: none;
    }

    #toolbar {
      display: flex;
      gap: 8px;
      align-items: center;
      padding: 8px;
      background: var(--toolbar-bg);
      border-bottom: 1px solid var(--border);
      overflow-x: auto;
      white-space: nowrap;
      -webkit-overflow-scrolling: touch;
      flex-shrink: 0;
    }
    #toolbar::-webkit-scrollbar { display: none; }

    .btn {
      border: 1px solid var(--border);
      background: var(--bg);
      color: var(--text);
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 13px;
      cursor: pointer;
      user-select: none;
      flex-shrink: 0;
    }
    .btn:active { opacity: 0.7; }
    .btn.active {
      border-color: var(--accent);
      color: var(--accent);
      background: var(--active-line);
    }
    .btn.btn-icon {
      padding: 6px 8px;
      min-width: 28px;
    }

    #editor-container {
      position: relative;
      flex: 1;
      display: flex;
      min-height: 0;
    }

    #editor {
      flex: 1;
      min-height: 0;
    }
    .cm-editor {
      height: 100%;
    }
    #search-box {
      position: absolute;
      top: 0; right: 0;
      background: var(--toolbar-bg);
      padding: 6px;
      border-bottom: 1px solid var(--border);
      border-left: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 6px;
      z-index: 10;
      transform: translateY(-100%);
      transition: transform 0.2s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    #search-box.visible { transform: translateY(0); }
    .search-row { display: flex; gap: 4px; align-items: center; }
    .search-input {
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 4px 6px;
      font-size: 13px;
      width: 140px;
      border-radius: 3px;
    }
    .search-input:focus { border-color: var(--accent); }

    #format-options {
      position: absolute;
      top: 44px;
      right: 8px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.12);
      padding: 8px 10px;
      display: none;
      z-index: 30;
      font-size: 13px;
    }
    #format-options.show { display: block; }
    #format-options .opt {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
    }
    #format-options input[type="checkbox"] {
      width: 14px;
      height: 14px;
      margin: 0;
    }
    #format-options select {
      background: var(--bg);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 2px 6px;
      font-size: 12px;
    }

    #toast {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8);
      color: #fff;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 12px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 20;
    }
    #toast.show { opacity: 1; }

    #log-panel {
      position: absolute;
      left: 8px;
      right: 8px;
      bottom: 8px;
      max-height: 40%;
      display: none;
      flex-direction: column;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.15);
      z-index: 40;
      overflow: hidden;
    }
    #log-panel.show { display: flex; }
    #log-header {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 8px;
      border-bottom: 1px solid var(--border);
      background: var(--toolbar-bg);
      font-size: 12px;
    }
    #log-header .spacer { flex: 1; }
    #log-body {
      margin: 0;
      padding: 8px;
      font-size: 12px;
      line-height: 1.4;
      white-space: pre-wrap;
      word-break: break-all;
      overflow: auto;
      flex: 1;
    }
  </style>
</head>
<body>

  <div id="toolbar">
    <button id="undoBtn" class="btn">撤销</button>
    <button id="redoBtn" class="btn">重做</button>
    <button id="wrapBtn" class="btn">换行</button>
    <button id="formatBtn" class="btn">格式化</button>
    <button id="formatOptionsBtn" class="btn btn-icon" title="格式化选项">▾</button>
    <button id="searchToggleBtn" class="btn">🔍</button>
    <button id="logToggleBtn" class="btn">日志</button>
  </div>

  <div id="format-options">
    <label class="opt">
      <input id="wrapElementsToggle" type="checkbox" checked />
      <span>元素换行</span>
    </label>
    <label class="opt">
      <span>缩进</span>
      <select id="indentSizeSelect">
        <option value="2" selected>2</option>
        <option value="4">4</option>
      </select>
    </label>
    <label class="opt">
      <span>字号</span>
      <select id="fontSizeSelect">
        <option value="auto" selected>自动</option>
        <option value="12">12</option>
        <option value="13">13</option>
        <option value="14">14</option>
        <option value="16">16</option>
      </select>
    </label>
    <label class="opt">
      <span>宽度</span>
      <select id="printWidthSelect">
        <option value="80">80</option>
        <option value="120" selected>120</option>
        <option value="160">160</option>
      </select>
    </label>
    <label class="opt">
      <span>主题</span>
      <select id="themeSelect">
        <option value="auto" selected>系统</option>
        <option value="light">浅色</option>
        <option value="dark">深色</option>
        <option value="sepia">护眼</option>
        <option value="nord">极夜</option>
      </select>
    </label>
    <label class="opt">
      <input id="singleQuoteToggle" type="checkbox" />
      <span>单引号</span>
    </label>
    <label class="opt">
      <input id="trailingCommaToggle" type="checkbox" checked />
      <span>末尾逗号</span>
    </label>
  </div>

  <div id="search-box">
    <div class="search-row">
      <input id="search-input" class="search-input" type="text" placeholder="查找..." />
      <button id="findPrevBtn" class="btn">↑</button>
      <button id="findNextBtn" class="btn">↓</button>
      <button id="closeSearchBtn" class="btn" style="border:none;">×</button>
    </div>
    <div class="search-row">
      <input id="replace-input" class="search-input" type="text" placeholder="替换为..." />
      <button id="replaceBtn" class="btn">替换</button>
      <button id="replaceAllBtn" class="btn">全部</button>
    </div>
  </div>

  <div id="log-panel">
    <div id="log-header">
      <span>日志</span>
      <span class="spacer"></span>
      <button id="logClearBtn" class="btn btn-icon">清空</button>
      <button id="logCloseBtn" class="btn btn-icon">×</button>
    </div>
    <pre id="log-body"></pre>
  </div>

  <div id="editor-container">
    <div id="editor"></div>
  </div>

  <div id="toast"></div>

  <script src="standalone.min.js"></script>
  <script src="babel.js"></script>
  <script src="estree.js"></script>
  <script src="codemirror.bundle.js"></script>
  <script>
    (function () {
      const $ = (id) => document.getElementById(id);
      const LOG_MAX = 200;
      const SETTINGS_KEY = "legado.codeEditor.formatSettings";
      const TOAST_MS = 1500;

      function debounce(fn, wait) {
        let t;
        return function (...args) {
          clearTimeout(t);
          t = setTimeout(() => fn.apply(this, args), wait);
        };
      }

      const dom = {
        editorHost: $("editor"),
        toast: $("toast"),
        logPanel: $("log-panel"),
        logBody: $("log-body"),
        undoBtn: $("undoBtn"),
        redoBtn: $("redoBtn"),
        wrapBtn: $("wrapBtn"),
        formatBtn: $("formatBtn"),
        formatOptionsBtn: $("formatOptionsBtn"),
        searchToggleBtn: $("searchToggleBtn"),
        logToggleBtn: $("logToggleBtn"),
        logCloseBtn: $("logCloseBtn"),
        logClearBtn: $("logClearBtn"),
        wrapElementsToggle: $("wrapElementsToggle"),
        indentSizeSelect: $("indentSizeSelect"),
        fontSizeSelect: $("fontSizeSelect"),
        printWidthSelect: $("printWidthSelect"),
        themeSelect: $("themeSelect"),
        singleQuoteToggle: $("singleQuoteToggle"),
        trailingCommaToggle: $("trailingCommaToggle"),
        formatOptions: $("format-options"),
        searchBox: $("search-box"),
        searchInput: $("search-input"),
        replaceInput: $("replace-input"),
        findPrevBtn: $("findPrevBtn"),
        findNextBtn: $("findNextBtn"),
        replaceBtn: $("replaceBtn"),
        replaceAllBtn: $("replaceAllBtn"),
        closeSearchBtn: $("closeSearchBtn")
      };

      const CM = window.CodeMirrorBundle;
      if (!CM || !CM.EditorView) {
        dom.toast.textContent = "CodeMirror 未加载";
        dom.toast.classList.add("show");
        return;
      }

      const {
        EditorState,
        Compartment,
        EditorView,
        keymap,
        lineNumbers,
        highlightActiveLineGutter,
        history,
        historyKeymap,
        defaultKeymap,
        undo,
        redo,
        indentOnInput,
        bracketMatching,
        syntaxHighlighting,
        defaultHighlightStyle,
        javascript
      } = CM;

      let isWrap = false;
      let wrapElements = true;
      let tabSize = 2;
      let fontSize = "auto";
      let printWidth = 120;
      let singleQuote = false;
      let trailingComma = true;
      let themeMode = "auto";
      let TAB = "  ";

      let logLines = [];
      let isLogOpen = false;

      function appendLog(level, msg) {
        const time = new Date().toISOString().replace("T", " ").replace("Z", "");
        const text = String(msg == null ? "" : msg);
        const line = `[${time}] ${level}: ${text.length > 1000 ? text.slice(0, 1000) + "…" : text}`;
        logLines.push(line);
        if (logLines.length > LOG_MAX) logLines.shift();
        if (isLogOpen && dom.logBody) {
          dom.logBody.textContent = logLines.join("\n");
          dom.logBody.scrollTop = dom.logBody.scrollHeight;
        }
      }

      function loadSettings() {
        try {
          const raw = window.localStorage ? window.localStorage.getItem(SETTINGS_KEY) : null;
          if (!raw) return;
          const data = JSON.parse(raw);
          if (data && typeof data === "object") {
            if (typeof data.wrapElements === "boolean") wrapElements = data.wrapElements;
            if (data.tabSize != null) tabSize = parseInt(data.tabSize, 10) || tabSize;
            if (data.fontSize != null) fontSize = String(data.fontSize);
            if (data.printWidth != null) printWidth = parseInt(data.printWidth, 10) || printWidth;
            if (typeof data.singleQuote === "boolean") singleQuote = data.singleQuote;
            if (typeof data.trailingComma === "boolean") trailingComma = data.trailingComma;
            if (typeof data.themeMode === "string") themeMode = data.themeMode;
          }
        } catch (e) {}
      }

      function saveSettings() {
        try {
          if (!window.localStorage) return;
          const data = {
            wrapElements,
            tabSize,
            fontSize,
            printWidth,
            singleQuote,
            trailingComma,
            themeMode
          };
          window.localStorage.setItem(SETTINGS_KEY, JSON.stringify(data));
        } catch (e) {}
      }

      const wrapComp = new Compartment();
      const themeComp = new Compartment();
      const fontComp = new Compartment();

      function isDarkTheme() {
        return themeMode === "dark" || themeMode === "nord";
      }

      function getSystemFontSize() {
        const size = parseFloat(window.getComputedStyle(document.body).fontSize);
        return isNaN(size) ? 13 : size;
      }

      function makeFontTheme() {
        const px = fontSize === "auto" ? getSystemFontSize() : (parseInt(fontSize, 10) || 13);
        return EditorView.theme({
          ".cm-scroller": {
            fontFamily: "inherit",
            fontSize: px + "px",
            lineHeight: "1.5",
            overflow: "auto"
          },
          ".cm-content": { padding: "10px" },
          ".cm-gutters": { fontSize: px + "px" }
        });
      }

      function makeTheme() {
        return EditorView.theme({
          "&": {
            height: "100%",
            backgroundColor: "var(--bg)",
            color: "var(--text)"
          },
          ".cm-gutters": {
            backgroundColor: "var(--gutter-bg)",
            color: "var(--gutter-text)",
            borderRight: "1px solid var(--border)"
          },
          ".cm-activeLine": { backgroundColor: "var(--active-line)" },
          ".cm-selectionBackground": { backgroundColor: "var(--selection)" }
        }, { dark: isDarkTheme() });
      }

      function applyTheme(mode) {
        themeMode = mode || "auto";
        if (themeMode === "auto") {
          document.body.removeAttribute("data-theme");
        } else {
          document.body.setAttribute("data-theme", themeMode);
        }
        if (view) {
          view.dispatch({ effects: themeComp.reconfigure(makeTheme()) });
        }
      }

      function applyTabSize(size) {
        tabSize = size;
        TAB = " ".repeat(tabSize);
      }

      function applyFontSize(size) {
        fontSize = size;
        if (view) {
          view.dispatch({ effects: fontComp.reconfigure(makeFontTheme()) });
        }
      }

      function insertTab(view) {
        view.dispatch(view.state.replaceSelection(" ".repeat(tabSize)));
        return true;
      }

      function buildExtensions() {
        const tabKey = { key: "Tab", run: insertTab };
        return [
          history(),
          keymap.of([tabKey, ...defaultKeymap, ...historyKeymap]),
          lineNumbers(),
          highlightActiveLineGutter(),
          wrapComp.of(isWrap ? EditorView.lineWrapping : []),
          javascript(),
          indentOnInput(),
          bracketMatching(),
          syntaxHighlighting(defaultHighlightStyle, { fallback: true }),
          themeComp.of(makeTheme()),
          fontComp.of(makeFontTheme())
        ];
      }

      loadSettings();

      let view = new EditorView({
        state: EditorState.create({ doc: "", extensions: buildExtensions() }),
        parent: dom.editorHost
      });

      function getCode() {
        return view.state.doc.toString();
      }

      function resetDoc(text) {
        const doc = text || "";
        view.setState(EditorState.create({ doc, extensions: buildExtensions() }));
      }

      function setSelectionRange(start, end) {
        view.dispatch({ selection: { anchor: start, head: end }, scrollIntoView: true });
        view.focus();
      }

      function detectWrapper(rawText) {
        const raw = rawText || "";
        const trimmed = raw.trim();
        const jsPrefixMatch = raw.match(/^\s*@js:\s*[\r\n]?([\s\S]*)$/);
        if (jsPrefixMatch) {
          return { type: "prefix", prefix: "@js:", body: jsPrefixMatch[1] || "" };
        }
        const tagMatch = trimmed.match(/^<js>\s*([\s\S]*?)\s*<\/js>$/i);
        if (tagMatch) {
          return { type: "tag", open: "<js>", close: "</js>", body: tagMatch[1] };
        }
        const braceMatch = trimmed.match(/^\{\{\s*([\s\S]*?)\s*\}\}$/);
        if (braceMatch) {
          return { type: "moustache", body: braceMatch[1] };
        }
        return null;
      }

      async function formatWithPrettier(codeText, parser) {
        if (!window.prettier || !window.prettierPlugins) {
          throw new Error("Prettier 未加载");
        }
        const plugins = [];
        if (window.prettierPlugins.babel) plugins.push(window.prettierPlugins.babel);
        if (window.prettierPlugins.estree) plugins.push(window.prettierPlugins.estree);
        if (!plugins.length) {
          throw new Error("Prettier 插件未加载");
        }
        const width = wrapElements ? printWidth : Math.max(printWidth, 99999);
        return window.prettier.format(codeText, {
          parser: parser || "babel",
          plugins: plugins,
          tabWidth: tabSize,
          useTabs: false,
          singleQuote: singleQuote,
          trailingComma: trailingComma ? "es5" : "none",
          printWidth: width
        });
      }

      async function formatCode() {
        const raw = getCode();
        const text = raw.trim();
        if (!text) return;
        showToast("格式化中...");
        await new Promise(requestAnimationFrame);
        try {
          const wrapper = detectWrapper(raw);
          let formattedBody = await formatWithPrettier(wrapper ? wrapper.body : text, "babel");
          if (wrapper) {
            if (wrapper.type === "prefix") {
              formattedBody = wrapper.prefix + "\n" + formattedBody;
            } else if (wrapper.type === "tag") {
              formattedBody = wrapper.open + "\n" + formattedBody + "\n" + wrapper.close;
            } else if (wrapper.type === "moustache") {
              formattedBody = "{{\n" + formattedBody + "\n}}";
            }
          }
          resetDoc(formattedBody);
          showToast("格式化完成（Prettier）");
        } catch (e) {
          appendLog("error", e && e.message ? e.message : e);
          showToast("格式化失败");
        }
      }

      dom.undoBtn.onclick = () => undo(view);
      dom.redoBtn.onclick = () => redo(view);
      dom.formatBtn.onclick = formatCode;

      const wrapBtn = dom.wrapBtn;
      wrapBtn.onclick = () => {
        isWrap = !isWrap;
        view.dispatch({ effects: wrapComp.reconfigure(isWrap ? EditorView.lineWrapping : []) });
        wrapBtn.classList.toggle("active", isWrap);
        showToast("自动换行: " + (isWrap ? "开" : "关"));
      };
      const formatOptionsBtn = dom.formatOptionsBtn;
      const formatOptions = dom.formatOptions;
      const wrapElementsToggle = dom.wrapElementsToggle;
      const indentSizeSelect = dom.indentSizeSelect;
      const fontSizeSelect = dom.fontSizeSelect;
      const printWidthSelect = dom.printWidthSelect;
      const themeSelect = dom.themeSelect;
      const singleQuoteToggle = dom.singleQuoteToggle;
      const trailingCommaToggle = dom.trailingCommaToggle;

      wrapElementsToggle.checked = wrapElements;
      indentSizeSelect.value = String(tabSize);
      fontSizeSelect.value = String(fontSize);
      printWidthSelect.value = String(printWidth);
      themeSelect.value = String(themeMode);
      singleQuoteToggle.checked = singleQuote;
      trailingCommaToggle.checked = trailingComma;

      applyTabSize(tabSize);
      applyFontSize(fontSize);
      applyTheme(themeMode);

      wrapElementsToggle.addEventListener("change", () => {
        wrapElements = wrapElementsToggle.checked;
        showToast("元素换行: " + (wrapElements ? "开" : "关"));
        saveSettings();
      });
      indentSizeSelect.addEventListener("change", () => {
        applyTabSize(parseInt(indentSizeSelect.value, 10) || 2);
        showToast("缩进: " + tabSize);
        saveSettings();
      });
      fontSizeSelect.addEventListener("change", () => {
        applyFontSize(fontSizeSelect.value || "auto");
        showToast("字号: " + (fontSize === "auto" ? "自动" : fontSize));
        saveSettings();
      });
      printWidthSelect.addEventListener("change", () => {
        printWidth = parseInt(printWidthSelect.value, 10) || 120;
        showToast("宽度: " + printWidth);
        saveSettings();
      });
      themeSelect.addEventListener("change", () => {
        applyTheme(themeSelect.value || "auto");
        showToast("主题: " + (themeMode === "auto" ? "系统" : themeMode));
        saveSettings();
      });
      singleQuoteToggle.addEventListener("change", () => {
        singleQuote = singleQuoteToggle.checked;
        showToast("单引号: " + (singleQuote ? "开" : "关"));
        saveSettings();
      });
      trailingCommaToggle.addEventListener("change", () => {
        trailingComma = trailingCommaToggle.checked;
        showToast("末尾逗号: " + (trailingComma ? "开" : "关"));
        saveSettings();
      });

      formatOptionsBtn.onclick = (e) => {
        e.stopPropagation();
        formatOptions.classList.toggle("show");
      };
      document.addEventListener("click", (e) => {
        if (!formatOptions.classList.contains("show")) return;
        if (formatOptions.contains(e.target) || e.target === formatOptionsBtn) return;
        formatOptions.classList.remove("show");
      });

      const searchBox = dom.searchBox;
      const searchInput = dom.searchInput;
      const replaceInput = dom.replaceInput;
      const findPrevBtn = dom.findPrevBtn;
      const findNextBtn = dom.findNextBtn;
      const replaceBtn = dom.replaceBtn;
      const replaceAllBtn = dom.replaceAllBtn;
      const closeSearchBtn = dom.closeSearchBtn;

      dom.searchToggleBtn.onclick = () => {
        searchBox.classList.add("visible");
        searchInput.focus();
      };
      closeSearchBtn.onclick = () => searchBox.classList.remove("visible");

      function doSearch(dir) {
        const query = searchInput.value;
        if (!query) return;
        const text = getCode();
        let index = -1;
        const sel = view.state.selection.main;
        if (dir === 1) {
          const startPos = sel.to;
          index = text.indexOf(query, startPos);
          if (index === -1) index = text.indexOf(query, 0);
        } else {
          const startPos = Math.max(0, sel.from - 1);
          index = text.lastIndexOf(query, startPos);
          if (index === -1) index = text.lastIndexOf(query);
        }
        if (index !== -1) {
          setSelectionRange(index, index + query.length);
        } else {
          showToast("未找到内容");
        }
      }

      function doReplace(all) {
        const query = searchInput.value;
        if (!query) return;
        const replacement = replaceInput.value || "";
        if (all) {
          const text = getCode();
          if (text.includes(query)) {
            resetDoc(text.split(query).join(replacement));
            showToast("全部替换完成");
          }
          return;
        }
        const sel = view.state.selection.main;
        const selected = view.state.doc.sliceString(sel.from, sel.to);
        if (selected === query) {
          view.dispatch({ changes: { from: sel.from, to: sel.to, insert: replacement } });
          doSearch(1);
        } else {
          doSearch(1);
        }
      }

      findNextBtn.onclick = () => doSearch(1);
      findPrevBtn.onclick = () => doSearch(-1);
      replaceBtn.onclick = () => doReplace(false);
      replaceAllBtn.onclick = () => doReplace(true);

      const logToggleBtn = dom.logToggleBtn;
      const logCloseBtn = dom.logCloseBtn;
      const logClearBtn = dom.logClearBtn;
      logToggleBtn.onclick = () => {
        dom.logPanel.classList.toggle("show");
        isLogOpen = dom.logPanel.classList.contains("show");
        if (isLogOpen && dom.logBody) {
          dom.logBody.textContent = logLines.join("\n");
          dom.logBody.scrollTop = dom.logBody.scrollHeight;
        }
      };
      logCloseBtn.onclick = () => {
        dom.logPanel.classList.remove("show");
        isLogOpen = false;
      };
      logClearBtn.onclick = () => {
        logLines = [];
        if (isLogOpen && dom.logBody) dom.logBody.textContent = "";
      };

      let toastTimer = null;
      function showToast(msg) {
        dom.toast.textContent = msg;
        dom.toast.classList.add("show");
        clearTimeout(toastTimer);
        toastTimer = setTimeout(() => dom.toast.classList.remove("show"), TOAST_MS);
      }

      function b64ToUtf8(b64) {
        try { return decodeURIComponent(escape(window.atob(b64))); } catch (e) { return ""; }
      }

      window.setCodeFromAndroid = function (b64) {
        resetDoc(b64ToUtf8(b64));
      };

      window.__save = function () {
        const val = getCode();
        if (window.Android && window.Android.save) window.Android.save(val);
        else console.log("Mock Save:", val);
      };

      window.__getCode = function () {
        return getCode();
      };

      if (window.visualViewport) {
        const syncViewport = () => {
          const h = window.visualViewport.height;
          document.documentElement.style.height = h + "px";
          document.body.style.height = h + "px";
          if (fontSize === "auto") applyFontSize("auto");
        };
        const vvSync = debounce(syncViewport, 50);
        window.visualViewport.addEventListener("resize", vvSync);
        window.visualViewport.addEventListener("scroll", vvSync);
        syncViewport();
      }

      window.addEventListener("resize", () => {
        if (fontSize === "auto") applyFontSize("auto");
      });
      window.addEventListener("error", (e) => {
        const msg = e && e.message ? e.message : "发生未知错误";
        appendLog("error", msg);
        showToast("发生错误：" + msg);
      });
      window.addEventListener("unhandledrejection", (e) => {
        const reason = e && e.reason ? e.reason : "发生未知错误";
        appendLog("promise", reason);
        showToast("发生错误：" + reason);
      });
      const __err = console.error.bind(console);
      console.error = function (...args) {
        const safe = args.map(a => {
          if (typeof a === "string") return a;
          try { return JSON.stringify(a); } catch (e) { return String(a); }
        }).join(" ");
        appendLog("error", safe);
        __err(...args);
      };
    })();
  </script>
</body>
</html>
